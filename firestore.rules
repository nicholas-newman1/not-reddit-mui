rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function onlyMarker() {
      return incomingData().keys().hasOnly(["exists"]) 
        && incomingData().exists == true;
    }
    
    function incomingData() {
    	return request.resource.data;
    }

    function isVerified() {
      return request.auth.token.email_verified == true;
    }

    function documentFieldsCheckOut(requiredFields, optionalFields) {
      let allFields = requiredFields.concat(optionalFields);
      let requestKeys = incomingData().keys();
      return requestKeys.hasAll(requiredFields) && requestKeys.hasOnly(allFields);
    }

    // function editChangesOnlyFields(allowedFields) {
    //   let affectedKeys = incomingData().diff(resource.data).affectedKeys();
    //   return affectedKeys.hasOnly(allowedFields);
    // }

    function categoryExists(categoryId) {
      return exists(/databases/$(database)/documents/categories/$(categoryId))
    }

    function isOwnerOfCategory(uid, categoryId) {
      return uid == get(/databases/$(database)/documents/categories/$(categoryId)).data.ownerId;
    }

    function isModeratorOfCategory(uid, categoryId) {
      return exists(/databases/$(database)/documents/categories/$(categoryId)/moderatorIds/$(uid));
    }
    
    function isSubscriberOfCategory(uid, categoryId) {
      return exists(/databases/$(database)/documents/categories/$(categoryId)/subscriberIds/$(uid));
    }

    function isBannedFromCategory(uid, categoryId) {
      return exists(/databases/$(database)/documents/categories/$(categoryId)/bannedIds/$(uid));
    }

    // Rules
    match /users/{userId} {      
      allow read;
      allow create, update: if request.auth.uid == userId && documentFieldsCheckOut(['username'], []);
    }

    match /categories/{categoryId} {  
      allow read;

      allow create: if documentFieldsCheckOut(['ownerId'], []) 
        && request.auth.uid == request.resource.data.ownerId
        && isVerified()
        && categoryId.size() > 2
        && categoryId.matches('^[a-z0-9]+$');

      allow update: if documentFieldsCheckOut(['ownerId'], [])
        && isVerified()
        && isOwnerOfCategory(request.auth.uid, categoryId);

      match /moderatorIds/{moderatorId} {
        allow create: if onlyMarker()
          && isVerified()
          && isOwnerOfCategory(request.auth.uid, categoryId);
        allow delete: if isVerified()
          && (
            isOwnerOfCategory(request.auth.uid, categoryId) 
            || request.auth.uid == moderatorId
          );
      }

      match /subscriberIds/{subscriberId} {
        allow create: if
          onlyMarker()
          && request.auth.uid == subscriberId
          && isVerified()
          && categoryExists(categoryId)
          && !isBannedFromCategory(request.auth.uid, categoryId)
          
        allow delete: if isVerified()
          && (
            isOwnerOfCategory(request.auth.uid, categoryId) 
            || isModeratorOfCategory(request.auth.uid, categoryId) 
            || request.auth.uid == subscriberId
          );
      }

      match /bannedIds/{bannedId} {
        allow create: if onlyMarker()
        && isVerified()
        && (
          (
            isModeratorOfCategory(request.auth.uid, categoryId) 
            && !isOwnerOfCategory(bannedId, categoryId)
          )          
          || isOwnerOfCategory(request.auth.uid, categoryId)
        );

        allow delete: if isVerified()
          && (
            isModeratorOfCategory(request.auth.uid, categoryId) 
            || isOwnerOfCategory(request.auth.uid, categoryId)
          );      
      }
    }

    match /posts/{postId} {
      allow read;
      allow create: if isVerified() 
        && documentFieldsCheckOut(['title', 'body', 'authorId', 'categoryId'], [])
        && incomingData().title is string
        && incomingData().title.size() >= 3
        && incomingData().body is string
        && incomingData().authorId == request.auth.uid
        && categoryExists(incomingData().categoryId)
        && (
          isSubscriberOfCategory(request.auth.uid, incomingData().categoryId) 
          || isModeratorOfCategory(request.auth.uid, incomingData().categoryId)
          || isOwnerOfCategory(request.auth.uid, incomingData().categoryId)
          )
        && !isBannedFromCategory(request.auth.uid, incomingData().categoryId)
    }
  }
}